generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum PaymentStatus {
  PAID
  UNPAID
  PARTIAL
}

enum ExpenseCategory {
  INVENTORY
  UTILITIES
  TRANSPORT
  OTHER
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  phone     String?
  avatar    String?
  address   String?
  salary    Decimal? @db.Decimal(10, 2)
  role      Role     @default(EMPLOYEE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales              Sale[]
  expenses           Expense[]
  purchases          Purchase[]
  dismissedBorrows   BorrowRecord[] @relation("DismissedBy")
  salaryPayments     SalaryPayment[]

  @@map("users")
}

enum SalaryStatus {
  PENDING
  PAID
}

model SalaryPayment {
  id          Int          @id @default(autoincrement())
  userId      Int
  amount      Decimal      @db.Decimal(10, 2)
  month       String
  year        Int
  status      SalaryStatus @default(PENDING)
  notes       String?
  paidAt      DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, month, year])
  @@map("salary_payments")
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  mobile    String   @unique
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales Sale[]

  @@map("customers")
}

model InventoryItem {
  id               Int      @id @default(autoincrement())
  name             String
  unit             String
  category         String   @default("Other")
  purchaseRate     Decimal  @db.Decimal(10, 2)
  sellingRate      Decimal  @db.Decimal(10, 2)
  quantity         Int      @default(0)
  totalPurchased   Int      @default(0)
  totalSold        Int      @default(0)
  lowStockThreshold Int     @default(10)
  imageUrl         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  purchases Purchase[]
  saleItems SaleItem[]

  @@map("inventory_items")
}

model Purchase {
  id           Int      @id @default(autoincrement())
  itemId       Int
  quantity     Int
  rate         Decimal  @db.Decimal(10, 2)
  totalCost    Decimal  @db.Decimal(10, 2)
  purchaseDate DateTime @default(now())
  createdBy    Int
  createdAt    DateTime @default(now())

  item    InventoryItem @relation(fields: [itemId], references: [id])
  creator User          @relation(fields: [createdBy], references: [id])

  @@map("purchases")
}

model Sale {
  id            Int           @id @default(autoincrement())
  orderNumber   String        @unique
  customerId    Int?
  totalAmount   Decimal       @db.Decimal(10, 2)
  isBorrow      Boolean       @default(false)
  paymentStatus PaymentStatus @default(PAID)
  notes         String?       @db.Text
  clientPhoto   String?
  createdBy     Int
  createdAt     DateTime      @default(now())

  customer     Customer?      @relation(fields: [customerId], references: [id])
  creator      User           @relation(fields: [createdBy], references: [id])
  items        SaleItem[]
  borrowRecord BorrowRecord?

  @@map("sales")
}

model SaleItem {
  id       Int     @id @default(autoincrement())
  saleId   Int
  itemId   Int?
  itemName String? @db.VarChar(100)
  quantity Int
  rate     Decimal @db.Decimal(10, 2)
  subtotal Decimal @db.Decimal(10, 2)

  sale Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)
  item InventoryItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@map("sale_items")
}

model Expense {
  id           Int             @id @default(autoincrement())
  description  String
  amount       Decimal         @db.Decimal(10, 2)
  category     ExpenseCategory @default(OTHER)
  expenseDate  DateTime        @default(now())
  receiptPhoto String?
  createdBy    Int
  createdAt    DateTime        @default(now())

  creator User @relation(fields: [createdBy], references: [id])

  @@map("expenses")
}

model BorrowRecord {
  id                 Int       @id @default(autoincrement())
  saleId             Int       @unique
  borrowDate         DateTime  @default(now())
  dueDate            DateTime
  outstandingAmount  Decimal   @db.Decimal(10, 2)
  isReturned         Boolean   @default(false)
  returnedAt         DateTime?
  reminderDismissed  Boolean   @default(false)
  dismissedBy        Int?
  dismissedAt        DateTime?

  sale      Sale  @relation(fields: [saleId], references: [id], onDelete: Cascade)
  dismisser User? @relation("DismissedBy", fields: [dismissedBy], references: [id])

  @@map("borrow_records")
}
